# Neo 3.9.1 Build Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Restore clean build/tests for Neo3-GUI on Neo 3.9.1 by fixing current compilation blockers and aligning LevelDB WriteBatch disposal.

**Architecture:** Minimal, targeted changes in storage utilities to re-enable compilation and deterministic resource cleanup. Add a small regression test for WriteBatch disposal semantics.

**Tech Stack:** .NET, MSTest, LevelDB native bindings

### Task 1: Fix AssetType compilation blocker

**Files:**
- Modify: `neo3-gui/neo3-gui/Common/Utility/AssetCache.cs`
- Test: `neo3-gui/neo3-gui.sln`

**Step 1: Verify current failure (baseline)**

Run: `dotnet test neo3-gui/neo3-gui.sln`

Expected: FAIL with CS0103 at `AssetCache.cs` and CS1061 for `WriteBatch.Dispose`.

**Step 2: Apply minimal namespace fix**

Update `AssetCache.cs` to reference `AssetType` via `using Neo.Common.Storage.SQLiteModules;` or fully qualify `AssetType`.

**Step 3: Verify compile progresses to next failure**

Run: `dotnet test neo3-gui/neo3-gui.sln`

Expected: FAIL with CS1061 for `WriteBatch.Dispose` only.

### Task 2: Add WriteBatch disposal test + implement IDisposable

**Files:**
- Create: `neo3-gui/neo3-gui.tests/Storage/WriteBatch_Test.cs`
- Modify: `neo3-gui/neo3-gui/Common/Storage/LevelDBModules/WriteBatch.cs`
- Test: `neo3-gui/neo3-gui.sln`

**Step 1: Write failing test**

Create `WriteBatch_Test.cs`:

```csharp
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Neo.Common.Storage.LevelDBModules;
using System;

namespace neo3_gui.tests.Storage
{
    [TestClass]
    public class WriteBatch_Test
    {
        [TestMethod]
        public void WriteBatch_Implements_IDisposable()
        {
            var batch = new WriteBatch();
            Assert.IsTrue(batch is IDisposable, "WriteBatch should implement IDisposable for deterministic cleanup.");
        }
    }
}
```

**Step 2: Run tests to verify RED**

Run: `dotnet test neo3-gui/neo3-gui.sln`

Expected: FAIL (compilation error CS1061 in `LevelDbContext.cs` because `WriteBatch.Dispose` is missing).

**Step 3: Implement minimal IDisposable support**

Update `WriteBatch.cs` to implement `IDisposable` with a safe dispose pattern:

```csharp
public class WriteBatch : IDisposable
{
    private bool _disposed;
    internal readonly IntPtr handle = Native.leveldb_writebatch_create();

    ~WriteBatch()
    {
        Dispose(false);
    }

    public void Dispose()
    {
        Dispose(true);
        GC.SuppressFinalize(this);
    }

    protected virtual void Dispose(bool disposing)
    {
        if (_disposed)
        {
            return;
        }
        Native.leveldb_writebatch_destroy(handle);
        _disposed = true;
    }

    // existing Clear/Delete/Put methods remain unchanged
}
```

**Step 4: Run tests to verify GREEN**

Run: `dotnet test neo3-gui/neo3-gui.sln`

Expected: PASS all tests (or only the known ignored tests remain skipped).

