# Neo 3.9.1 Alignment Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Align Neo3-GUI dependencies and bundled LevelDBStore plugin to Neo 3.9.1, with build-time asset fetch and passing tests.

**Architecture:** Add a build-time fetch script that downloads the `Neo.Plugins.Storage.LevelDBStore` 3.9.1 NuGet package and extracts `LevelDBStore.dll` into `Plugins/LevelDBStore/`. Wire the script into publish/package flows and lock the `Neo` NuGet dependency to 3.9.1.

**Tech Stack:** .NET (net10), Node.js (build script), bash, npm/electron-builder.

### Task 1: Lock Neo dependency to 3.9.1 with a guard check

**Files:**
- Create: `neo3-gui/neo3-gui/scripts/check-neo-version.js`
- Modify: `neo3-gui/neo3-gui/neo3-gui.csproj`

**Step 1: Write the failing test**

```js
// scripts/check-neo-version.js
// Fails if Neo package version is not 3.9.1
```

**Step 2: Run test to verify it fails**

Run: `node neo3-gui/neo3-gui/scripts/check-neo-version.js`
Expected: FAIL with message showing current Neo version != 3.9.1

**Step 3: Write minimal implementation**

```xml
<PackageReference Include="Neo" Version="3.9.1" />
```

**Step 4: Run test to verify it passes**

Run: `node neo3-gui/neo3-gui/scripts/check-neo-version.js`
Expected: PASS (exit 0)

**Step 5: Commit**

```bash
git add neo3-gui/neo3-gui/scripts/check-neo-version.js neo3-gui/neo3-gui/neo3-gui.csproj
git commit -m "chore: pin Neo dependency to 3.9.1"
```

### Task 2: Add LevelDBStore fetcher (NuGet â†’ Plugins)

**Files:**
- Create: `neo3-gui/neo3-gui/scripts/fetch-leveldbstore.js`
- Create: `neo3-gui/neo3-gui/scripts/fetch-leveldbstore.test.js`
- Modify (generated by script): `neo3-gui/neo3-gui/Plugins/LevelDBStore/LevelDBStore.dll`

**Step 1: Write the failing test**

```js
// scripts/fetch-leveldbstore.test.js
// Asserts the computed NuGet URL for version 3.9.1 and expected DLL path
```

**Step 2: Run test to verify it fails**

Run: `node neo3-gui/neo3-gui/scripts/fetch-leveldbstore.test.js`
Expected: FAIL because fetch script does not exist yet

**Step 3: Write minimal implementation**

```js
// scripts/fetch-leveldbstore.js
// - Download https://api.nuget.org/v3-flatcontainer/neo.plugins.storage.leveldbstore/3.9.1/neo.plugins.storage.leveldbstore.3.9.1.nupkg
// - Extract lib/net10.0/LevelDBStore.dll
// - Overwrite Plugins/LevelDBStore/LevelDBStore.dll
// - Support --dry-run to print URL/paths
```

**Step 4: Run test to verify it passes**

Run: `node neo3-gui/neo3-gui/scripts/fetch-leveldbstore.test.js`
Expected: PASS

**Step 5: Run a dry-run fetch**

Run: `node neo3-gui/neo3-gui/scripts/fetch-leveldbstore.js --dry-run`
Expected: Prints URL and target path, exits 0

**Step 6: Run the real fetch**

Run: `node neo3-gui/neo3-gui/scripts/fetch-leveldbstore.js`
Expected: Downloads and replaces `Plugins/LevelDBStore/LevelDBStore.dll`

**Step 7: Commit**

```bash
git add neo3-gui/neo3-gui/scripts/fetch-leveldbstore.js neo3-gui/neo3-gui/scripts/fetch-leveldbstore.test.js neo3-gui/neo3-gui/Plugins/LevelDBStore/LevelDBStore.dll
git commit -m "chore: fetch LevelDBStore 3.9.1 from NuGet"
```

### Task 3: Wire fetcher into build and packaging

**Files:**
- Modify: `neo3-gui/neo3-gui/publish.sh`
- Modify: `neo3-gui/neo3-gui/publish.macos.sh`
- Modify: `neo3-gui/neo3-gui/ClientApp/package.json`

**Step 1: Write the failing test**

```bash
# scripts/fetch-leveldbstore.js --dry-run should be invoked before publish
```

**Step 2: Run test to verify it fails**

Run: `rg -n "fetch-leveldbstore" neo3-gui/neo3-gui/publish.sh neo3-gui/neo3-gui/publish.macos.sh neo3-gui/neo3-gui/ClientApp/package.json`
Expected: No matches

**Step 3: Write minimal implementation**

- Add `node scripts/fetch-leveldbstore.js` before `dotnet publish` in both publish scripts
- Add npm script `fetch-neo-assets` to call `node ../scripts/fetch-leveldbstore.js`
- Add `prepublish` to run `npm run fetch-neo-assets` so `npm run publish` always refreshes

**Step 4: Run test to verify it passes**

Run: `rg -n "fetch-leveldbstore" neo3-gui/neo3-gui/publish.sh neo3-gui/neo3-gui/publish.macos.sh neo3-gui/neo3-gui/ClientApp/package.json`
Expected: Matches in all three files

**Step 5: Commit**

```bash
git add neo3-gui/neo3-gui/publish.sh neo3-gui/neo3-gui/publish.macos.sh neo3-gui/neo3-gui/ClientApp/package.json
git commit -m "build: fetch LevelDBStore before packaging"
```

### Task 4: Update docs for Neo 3.9.1 alignment

**Files:**
- Modify: `README.md`
- Modify: `Changelog.md`

**Step 1: Write the failing test**

```bash
# Expect README/Changelog to mention Neo 3.9.1 and build-time plugin fetch
```

**Step 2: Run test to verify it fails**

Run: `rg -n "3.9.1" README.md Changelog.md`
Expected: No matches

**Step 3: Write minimal implementation**

- Add a short note to README about Neo 3.9.1 alignment and the fetch script
- Add Changelog entry noting LevelDBStore plugin and Neo dependency pinned to 3.9.1

**Step 4: Run test to verify it passes**

Run: `rg -n "3.9.1" README.md Changelog.md`
Expected: Matches in both files

**Step 5: Commit**

```bash
git add README.md Changelog.md
git commit -m "docs: note Neo 3.9.1 alignment"
```

### Task 5: Verification

**Files:**
- None

**Step 1: Run .NET tests**

Run: `dotnet test neo3-gui/neo3-gui.sln`
Expected: PASS

**Step 2: Run frontend tests**

Run: `cd neo3-gui/neo3-gui/ClientApp && npm install && CI=true npm test`
Expected: PASS (or 0 tests) with exit 0

**Step 3: Build package**

Run: `cd neo3-gui/neo3-gui && ./publish.sh`
Expected: SUCCESS, builds `ClientApp/build-electron`
